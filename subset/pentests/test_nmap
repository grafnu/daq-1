#!/bin/bash -e

LOG=/tmp/nmap.log
REPORT=/tmp/report.txt

ping -n -c 3 $TARGET_IP

echo Testing target $TARGET_IP port 23
nc -nzv $TARGET_IP -w 5 23 || true
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1

nmap -v -n -Pn -T4 --open -oG $LOG $TARGET_IP
cat $LOG

nothing=
grep -oh '[0-9]*/open/[^[:space:]]*' $LOG > $REPORT || nothing=y

echo

if [ -n "$nothing" ]; then
    echo No open ports found. | tee -a $REPORT
    result=pass
else
    echo Open ports:
    cat $REPORT
    result=fail
fi

echo RESULT $result security.ports.nmap | tee -a $REPORT

[ "$result" == pass ]
