#!/bin/bash -e

setup=aardvark,aardvark2,default,networking,switch
faux=faux1,faux2
faucet=faucet,gauge
base=test_bacnet,test_mudgee,test_brute,test_discover,usi,test_ipaddr
subset=test_switch,test_bacext,test_password,test_ssh,test_udmi,test_manual,test_network

shard=$2
targets=${!shard}
echo Building $shard targets $targets

output_path=$1/$shard
mkdir -p $output_path

host_tests=
if [ "$shard" == "subset" ]; then
    host_tests=config/modules/all.conf
fi

host_tests=$host_tests DAQ_TARGETS=$targets cmd/build
cp .build_built .build_hash $output_path/

for target in $(echo $targets | sed 's/,/ /g'); do
    tag=daqf/$target
    echo Saving Docker image $tag to $output_path
    docker save "$tag" > $output_path/$target.tar
done
