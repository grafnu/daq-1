#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT
source misc/config_base.sh

IPREFIX=ctrl

echo Cleaning old setup...
sudo ip link del ${IPREFIX}-pri 2>/dev/null || true
sudo ip link del ${IPREFIX}-br 2>/dev/null || true
sudo ip link del ${IPREFIX}-swx 2>/dev/null || true
sudo ip link del ${IPREFIX}-swa 2>/dev/null || true
sudo ovs-vsctl del-port pri ${IPREFIX}-pri 2>/dev/null || true

echo Creating local bridge...
sudo ip link add name ${IPREFIX}-br type bridge
sudo ip link set ${IPREFIX}-br up

echo Creating ovs-link interfaces...
sudo ip link add ${IPREFIX}-pri type veth peer name ${IPREFIX}-alt
sudo ip link set ${IPREFIX}-pri up
sudo ip link set ${IPREFIX}-alt up

echo Creating local-link interfaces...
sudo ip link add ${IPREFIX}-swx type veth peer name ${IPREFIX}-swy
sudo ip link set ${IPREFIX}-swx up
sudo ip link set ${IPREFIX}-swy up

echo Attaching to bridges...
sudo ip link set ${IPREFIX}-alt master ${IPREFIX}-br
sudo ip link set ${IPREFIX}-swx master ${IPREFIX}-br

if [ -z "$ext_ctrl" -a -n "$ext_addr" ]; then
    echo Creating daq-switch, because only ext_addr defined.

    docker rm -f daq-switch || true
    cid=$(docker run -d --privileged --name daq-switch --hostname switch --net=none daq/test_hold)
    pid=$(docker inspect --format="{{ .State.Pid }}" $cid)

    ipsuffix=${ext_ofip#*/}
    targetip=$ext_addr/${ipsuffix}
    echo Creating docker with veth -swb at $targetip
    sudo ip link add ${IPREFIX}-swa type veth peer name ${IPREFIX}-swb
    sudo ip link set ${IPREFIX}-swa up
    sudo ip link set ${IPREFIX}-swb netns $pid
    docker exec daq-switch ip addr add $targetip dev ${IPREFIX}-swb
    docker exec daq-switch ip link set ${IPREFIX}-swb up

    ext_ctrl=${IPREFIX}-swa
fi

if [ -z "$ext_ctrl" ]; then
    echo ext_ctrl not defined, skipping configuration.
else
    echo Bridging $ext_ctrl to ${IPREFIX}-br
    sudo ip link set $ext_ctrl master ${IPREFIX}-br
    sudo ip addr flush dev $ext_ctrl
fi

if [ -z "$ext_ofip" ]; then
    echo ext_ofip not defined, skipping configuration.
else
    echo Configuring ${IPREFIX}-swy with $ext_ofip
    sudo ip addr add $ext_ofip dev ${IPREFIX}-swy
fi

echo Adjust IP tables to enable bridge forwaring...
sudo iptables -A FORWARD -p all -i ${IPREFIX}-br -j ACCEPT

echo
echo TODO: Add appropriate IP address to test runner container:
echo '  root@hold01:~# ip addr add 192.0.2.11/16 dev hold01-eth0'
echo
echo Done with local switch setup.
