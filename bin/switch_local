#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT
source misc/config_base.sh

if [ -z "$ext_ctrl" ]; then
    echo ext_ctrl not defined.
    false
fi

if [ -z "$ext_ofip" ]; then
    echo ext_ofip not defined.
    false
fi

IPREFIX=ctrl

echo Cleaning old setup...
sudo ip link del ${IPREFIX}-pri 2>/dev/null || true
sudo ip link del ${IPREFIX}-alt 2>/dev/null || true
sudo ip link del ${IPREFIX}-br 2>/dev/null || true
sudo ovs-vsctl del-port pri ${IPREFIX}-pri 2>/dev/null || true

echo Creating local bridge...
sudo ip link add name ${IPREFIX}-br type bridge
sudo ip link set ${IPREFIX}-br up

echo Creating ovs-link interfaces...
sudo ip link add ${IPREFIX}-pri type veth peer name ${IPREFIX}-alt
sudo ip link set ${IPREFIX}-pri up
sudo ip link set ${IPREFIX}-alt up

echo Creating local-link interfaces...
sudo ip link add ${IPREFIX}-swx type veth peer name ${IPREFIX}-swy
sudo ip link set ${IPREFIX}-swx up
sudo ip link set ${IPREFIX}-swy up

echo Attaching to bridges...
sudo ovs-vsctl add-port pri ${IPREFIX}-pri -- set interface ${IPREFIX}-pri ofport_request=1000
sudo ip link set ${IPREFIX}-alt master ${IPREFIX}-br
sudo ip link set $ext_ctrl master ${IPREFIX}-br
sudo ip link set ${IPREFIX}-swx master ${IPREFIX}-br

echo Adjusting IP addresses...
sudo ip addr flush dev $ext_ctrl
sudo ip addr add $ext_ofip dev ${IPREFIX}-swy

echo NEED TO FIX IPTABLES

echo Done with local switch setup.
