#!/bin/bash

veths=`ip link | fgrep @| sed 's/@.*//' | awk '{ print $2 }'`
for veth in $veths; do
    echo Deleting veth $veth
    sudo ip link del $veth
done

if [ -n "$(which ovs-vsctl)" ]; then
    bridges=`sudo ovs-vsctl list-br`
    for bridge in $bridges; do
        echo Cleaning bridge $bridge...
        sudo timeout 10 ovs-vsctl --if-exists del-br $bridge || true
        sudo ovs-vsctl --if-exists del-br $bridge
    done
fi

# Kill running containers that are based on known images.
for image in daq/faucet daq/faux daqf/networking daqf/faux faucet/gauge; do
    echo Cleaning docker $image...
    images=$(docker ps --filter ancestor=$image -q)
    if [ -n "$images" ]; then
        docker kill $images > /dev/null
    fi
done

netnses=$(ip netns)
if [ -n "$netnses" ]; then
    for netns in $netnses; do
        echo Cleaning netns $netns...
        sudo ip netns del $netnses
    done
else
    echo No netnses to clean!
fi

echo Done with network cleanup.
